<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RYO Boosting</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            max-width: 100%;
            overflow-x: hidden;
        }
        .mobile-scrollable-container {
            max-height: 50vh;
            overflow-y: auto;
        }
        .long-text-ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        @media (max-width: 768px) {
            .responsive-card {
                width: 100%;
                margin: 0.5rem 0;
            }
            .btn-responsive {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            .navbar {
                flex-direction: column;
                align-items: center;
                padding: 0.5rem;
            }
            .navbar .flex-1, .navbar .flex-none {
                margin: 0.25rem 0;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-base-200">
    <!-- Navbar -->
    <div class="navbar bg-base-100 shadow-lg">
        <div class="flex-1">
            <a class="btn btn-ghost text-base sm:text-xl">
                <i data-feather="zap" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
                RYOBOOSTING
            </a>
        </div>
        <div class="flex-none">
            <button class="btn btn-ghost btn-sm" onclick="toggleTheme()">
                <i data-feather="moon" class="w-4 h-4 sm:w-5 sm:h-5"></i>
            </button>
        </div>
    </div>

    <div class="container mx-auto p-2 sm:p-4">
        <!-- Share Form -->
        <div class="card bg-base-100 shadow-xl responsive-card">
            <div class="card-body">
                <h2 class="card-title text-base sm:text-lg">
                    <i data-feather="share-2" class="w-5 h-5 sm:w-6 sm:h-6"></i> 
                    Start Share Process
                </h2>
                <form id="shareForm" class="space-y-3 sm:space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Cookies</span>
                        </label>
                        <textarea class="textarea textarea-bordered text-sm" id="cookies" rows="3"></textarea>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Post Link</span>
                        </label>
                        <input type="text" id="postLink" class="input input-bordered input-sm text-sm long-text-ellipsis">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Share Count</span>
                        </label>
                        <input type="number" id="shareCount" class="input input-bordered input-sm text-sm">
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-full btn-responsive">
                        <i data-feather="play" class="w-4 h-4 mr-2"></i>
                        Start Share
                    </button>
                </form>
            </div>
        </div>

        <!-- Active Processes -->
        <div class="card bg-base-100 shadow-xl mt-4 responsive-card">
            <div class="card-body">
                <h2 class="card-title text-base sm:text-lg">
                    <i data-feather="activity" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                    Active Processes
                </h2>
                <div id="activeProcesses" class="space-y-3 mobile-scrollable-container"></div>
            </div>
        </div>

        <!-- Logs -->
        <div class="card bg-base-100 shadow-xl mt-4 responsive-card">
            <div class="card-body">
                <div class="flex justify-between items-center">
                    <h2 class="card-title text-base sm:text-lg">
                        <i data-feather="list" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                        Logs
                    </h2>
                    <button class="btn btn-xs btn-ghost" onclick="clearLogs()">
                        <i data-feather="trash-2" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                        Clear
                    </button>
                </div>
                <div id="logs" class="mt-2 space-y-1 h-48 sm:h-64 overflow-y-auto text-xs sm:text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <dialog id="adminModal" class="modal">
        <div class="modal-box w-11/12 max-w-sm">
            <h3 class="font-bold text-base sm:text-lg">Admin Authentication Required</h3>
            <div class="form-control mt-2 sm:mt-4">
                <input type="password" id="adminPassword" class="input input-bordered input-sm" placeholder="Enter admin password">
            </div>
            <div class="modal-action">
                <button class="btn btn-error btn-sm" onclick="closeAdminModal()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="confirmAdminAction()">Confirm</button>
            </div>
        </div>
    </dialog>

    <script>
        feather.replace();
        const API_URL = 'https://ryoboostingapi.onrender.com';
        let pendingAction = null;

        function toggleTheme() {
            const html = document.querySelector('html');
            const currentTheme = html.getAttribute('data-theme');
            html.setAttribute('data-theme', currentTheme === 'dark' ? 'light' : 'dark');
        }

        async function startShare(event) {
            event.preventDefault();
            const data = {
                cookies: document.getElementById('cookies').value,
                post_link: document.getElementById('postLink').value,
                share_count: parseInt(document.getElementById('shareCount').value)
            };

            try {
                const response = await fetch(`${API_URL}/start_share`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                updateProcesses();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to start share process. Please check your inputs and connection.');
            }
        }

        async function stopProcess(processId) {
            pendingAction = { type: 'stop', processId };
            document.getElementById('adminModal').showModal();
        }

        async function deleteProcess(processId) {
            pendingAction = { type: 'delete', processId };
            document.getElementById('adminModal').showModal();
        }

        function closeAdminModal() {
            document.getElementById('adminModal').close();
            pendingAction = null;
        }

        async function confirmAdminAction() {
            const password = document.getElementById('adminPassword').value;
            if (!pendingAction) return;

            const endpoint = pendingAction.type === 'stop' ? 'stop_share' : 'delete_share';
            try {
                const response = await fetch(`${API_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        process_id: pendingAction.processId,
                        password: password
                    })
                });
                const result = await response.json();
                updateProcesses();
                closeAdminModal();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to perform action. Please check your password and connection.');
            }
        }

        async function updateProcesses() {
            try {
                const response = await fetch(`${API_URL}/active_processes`);
                const processes = await response.json();
                const container = document.getElementById('activeProcesses');
                container.innerHTML = '';

                for (const [id, process] of Object.entries(processes)) {
                    const processElement = document.createElement('div');
                    processElement.className = 'card bg-base-200';
                    processElement.innerHTML = `
                        <div class="card-body p-3">
                            <div class="flex justify-between items-center">
                                <div class="flex-grow mr-2">
                                    <h3 class="font-semibold text-xs sm:text-sm">Process ID: ${id.substr(0, 8)}</h3>
                                    <p class="text-xs sm:text-sm long-text-ellipsis">Post: ${process.post_link}</p>
                                    <div class="mt-1">
                                        <progress class="progress progress-primary w-full sm:w-56" 
                                                value="${process.progress}" max="100"></progress>
                                        <span class="text-xs">${process.current_count}/${process.share_count}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col space-y-1">
                                    <button class="btn btn-xs btn-warning" onclick="stopProcess('${id}')">
                                        <i data-feather="pause" class="w-3 h-3"></i>
                                    </button>
                                    <button class="btn btn-xs btn-error" onclick="deleteProcess('${id}')">
                                        <i data-feather="trash" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(processElement);
                }
                feather.replace();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function updateLogs() {
            try {
                const response = await fetch(`${API_URL}/get_logs`);
                const logs = await response.json();
                const container = document.getElementById('logs');
                container.innerHTML = ''; // Clear previous logs
                logs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = 'text-xs sm:text-sm';
                    logElement.textContent = log;
                    container.appendChild(logElement);
                });
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function clearLogs() {
            try {
                await fetch(`${API_URL}/clear_logs`, { method: 'POST' });
                document.getElementById('logs').innerHTML = '';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('shareForm').addEventListener('submit', startShare);
        setInterval(updateProcesses, 1000);
        setInterval(updateLogs, 1000);
    </script>
</body>
</html>
